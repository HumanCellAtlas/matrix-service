swagger: '2.0'
basePath: '/v0'
info:
  title: HCA Matrix Service
  description: Human Cell Atlas Matrix Service API
  version: 0.0.1
host: ${API_HOST}
schemes:
  - https
consumes:
  - application/json
produces:
  - application/json
definitions:
  MatrixRequest:
    type: object
    properties:
      bundle_fqids:
        type: array
        items:
          type: string
          format: dcp-fqid
      bundle_fqids_url:
        type: string
        format: url
      format:
        $ref: '#/definitions/MatrixFormat'
  MatrixFormat:
    type: string
    enum:
      - zarr
      - loom
      - csv
  MatrixResponse:
    type: object
    properties:
      request_id:
        type: string
        format: uuid
      status:
        $ref: '#/definitions/MatrixRequestStatus'
      matrix_location:
        type: string
      eta:
        type: string
      message:
        type: string
  MatrixRequestStatus:
    type: string
    enum:
      - In Progress
      - Complete
      - Failed
  MatrixResponseError:
    type: object
    properties:
      message:
        type: string
paths:
  /matrix:
    post:
      summary: "Submit a matrix query request."
      description: "Prepares a single expression matrix combining all expression matrices belonging to the specified
        analysis bundles. On success, this request will asynchronously start a job to prepare the expression matrix and
        return with the request ID of the job. The request ID can be used to retrieve the status and results of the job
        from the GET endpoint."
      operationId: matrix.lambdas.api.core.post_matrix
      tags:
        - API
      parameters:
        - in: body
          name: body
          description: "Use either bundle_fqids or bundle_fqids_url to specify input analysis bundles; bundle_fqids
            expects a list of fully-qualified IDs (bundle_uuid.bundle_version); bundle_fqids_url expects a
            URL that serves a Data Browser download manifest TSV file. Use the format field to specify the desired file
            format of the output expression matrix. Supported format values are 'zarr' and 'loom'."
          required: true
          schema:
            $ref: '#/definitions/MatrixRequest'
      responses:
        "202":
          description: "Matrix request accepted"
          schema:
            $ref: '#/definitions/MatrixResponse'
        "400":
          description: "Bad request"
          schema:
            $ref: '#/definitions/MatrixResponseError'
  /matrix/{request_id}:
    get:
      summary: "Retrieve the status, and result if available, of a matrix query request."
      description: "Returns the status, and URI of the result if available, of a matrix query request. The status of a
        request can be 'Complete', 'In Progress' or 'Failed'. If the request is 'Complete', the matrix_location field
        will be populated with an S3 location for 'zarr' requests, and a URL for 'loom' requests. If the request
        'Failed', the error message will be available in the message field."
      operationId: matrix.lambdas.api.core.get_matrix
      tags:
        - API
      parameters:
        - in: path
          name: request_id
          type: string
          description: "The request ID generated by a POST request."
          required: true
      responses:
        "200":
          description: "Request found"
          schema:
            $ref: '#/definitions/MatrixResponse'
        "404":
          description: "Request not found"
          schema:
            $ref: '#/definitions/MatrixResponseError'
