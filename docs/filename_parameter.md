# Filename Parameter Design Doc

The candidate `filename` parameter would be made available on the POST `/matrix` endpoint and would accept a string that
would be a portion of, or the entire output filename of the requested expression matrix. This design document proposes a
technical implementation and captures design considerations for further discussion.

## Design challenges and considerations

### Changing filename in S3

Currently, expression matrix files are named by their request hash and are stored/served from an S3 bucket. In order to
change the filename served to the user, a new file must be created and stored in S3. This can be done via an S3 copy
operation from the original expression matrix.

### Preserving cache functionality

The Matrix Service caches a request by the hash of its input parameters (bundle uuids, output format). Since the 
filename parameter only determines whether or not an S3 copy job will run, and does not affect any processes/artifacts
generated prior, naively hashing the filename parameter would result in inefficient use of the cache. Ideally, incoming
requests with matching hash parameters (bundle uuids, output format) to previous requests, but with differing filenames
will only execute an S3 copy job instead of processing an entirely new expression matrix.

### Naming collisions

Currently, expression matrices generated by the service are stored in the same bucket per environment. By accepting user
specified filenames, filename collisions must be handled. One option is to continue to include the request hash in the
final filename by appending it to the requested filename. This is not ideal as it would not implement a true file naming
capability. Alternatively, all expression matrices generated under the same request hash will be stored in S3 with the
request hash as a prefix (e.g. request_hash/request_hash.zarr, request_hash/filename.zarr...)

_Note:_ Some design considerations (preserving cache functionality, naming collisions) apply to and may be extended 
to enhancing the output format parameter to use the cache more efficiently in a similar way. However, this can be a
captured in another discussion.

## Proposal

The following proposes a new matrix request flow that supports a filename parameter and provides solutions
for the design considerations described above. A rough summary of changes with time estimates is provided at the bottom.

### New Request Flow
POST:
- Accept filename parameter on POST
- Write filename to Cache Table

Driver:
- Generate request hash (bundle uuids, output format)
- Is request hash cached:
  - True: do Copy Check if filename else Complete Request
  - False: continue to Mapper

Mapper:
- No change

Worker:
- Write to hash/hash.zarr instead of hash.zarr

Reducer:
- Write to hash/hash.zarr instead of hash.zarr
- if format == zarr and filename:
  - True: do Copy Job
  - False: do Batch conversion

Batch Converter:
- Write to hash/hash.format
- if filename:
  - True: do Copy Job
  - False: Complete Request

Copy check:
- Read Filename from Cache Table
- Read Available Filenames from State Table
- Check Filename in Available Filenames:
  - True: Complete Request
  - False: Copy job

Copy job (async batch job):
- Execute S3 copy job (hash/hash.format -> hash/filename-hash.format)
- Write filename to Available Filenames in State Table
- Complete Request

GET:
- Read filename from Cache Table
- If all(Expected == Completed) and (filename in Available Filenames) in State Table:
  - True: Return Complete
  - False: Return In Progress
  
### Changes summary
New:
- Copy job in AWS Batch (3 days)

Refactoring (2 days total):
- Add column "Filename" to Cache Table
  - Possibly rename Cache Table to Request Table
- Add column of type list "Available filenames" to State Table
- Add S3 copy flows (Driver, Reducer, Batch) (1 day)
- Prefix all expression matrix writes (worker, reducer, converter) with hash/ (1 day)
- On GET, add check that requested filename is in "Available Filenames"

Estimate (days to implement):
- Initial: 1 week
- Conservative: 1.5 weeks
